---
/**
 * Override PageTitle to add a lazy "Copy as Markdown" button beside the title.
 * The raw markdown body is embedded in a hidden script tag at build time.
 */
const { entry } = Astro.locals.starlightRoute;
const title = entry.data.title;
const body = entry.body;
const markdown = body ? `# ${title}\n\n${body}` : '';
---

<div class="title-row">
	<h1 id="_top">{title}</h1>
	{
		markdown && (
			<>
				<script
					id="md-src"
					type="application/json"
					set:html={JSON.stringify(markdown)}
				/>
				<button
					id="copy-md"
					class="copy-md print:hidden"
					type="button"
				>
					<span class="copy-md-label">Copy Markdown</span>
				</button>
			</>
		)
	}
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const btn = document.getElementById('copy-md');
		const src = document.getElementById('md-src');
		if (!btn || !src) return;

		const md = JSON.parse(src.textContent || '""');
		const label = btn.querySelector('.copy-md-label');

		btn.addEventListener('click', async () => {
			try {
				await navigator.clipboard.writeText(md);
			} catch {
				const ta = document.createElement('textarea');
				ta.value = md;
				ta.style.position = 'fixed';
				ta.style.opacity = '0';
				document.body.appendChild(ta);
				ta.select();
				document.execCommand('copy');
				document.body.removeChild(ta);
			}
			if (label) label.textContent = 'Copied!';
			btn.classList.add('copied');
			setTimeout(() => {
				btn.classList.remove('copied');
				if (label) label.textContent = 'Copy Markdown';
			}, 1500);
		});
	});
</script>

<style>
	@layer starlight.core {
		h1 {
			margin-top: 1rem;
			font-size: var(--sl-text-h1);
			line-height: var(--sl-line-height-headings);
			font-weight: 600;
			color: var(--sl-color-white);
		}
	}

	@layer starlight.components {
		.title-row {
			display: flex;
			align-items: baseline;
			gap: 0.5rem;
		}

		.copy-md {
			margin-left: auto;
			flex-shrink: 0;
			align-self: center;
			background: none;
			border: 1px solid var(--sl-color-gray-5);
			border-radius: 0.375rem;
			padding: 0.25rem 0.5rem;
			font: inherit;
			font-size: var(--sl-text-xs);
			color: var(--sl-color-gray-3);
			cursor: pointer;
			transition:
				color 0.2s,
				border-color 0.2s;
		}

		.copy-md:hover {
			color: var(--sl-color-white);
			border-color: var(--sl-color-gray-3);
		}

		.copy-md.copied .copy-md-label {
			color: var(--sl-color-green-high);
		}
		.copy-md.copied {
			border-color: var(--sl-color-green-high);
		}
	}
</style>
